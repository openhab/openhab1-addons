function subscribe(e){var t={url:e,maxRequest:256,timeout:59e3,attachHeadersAsQueryString:true,executeCallbackBeforeReconnect:false,transport:force_transport,fallbackTransport:fallbackProtocol,headers:{Accept:"application/json"}};t.onError=function(e){};t.onOpen=function(e){detectedTransport=e.transport};t.onMessage=function(e){if(e.status==200){var t=e.responseBody;if(t.length>0){try{updateWidgets(Ext.JSON.decode(t))}catch(n){}}}};socket.subscribe(t)}function unsubscribe(){socket.unsubscribe()}function getOpenhabVersion(){Ext.Ajax.request({url:"/static/version",success:function(e){oph_openHAB_version=e.responseText;getUpdateServer()}})}function getUpdateServer(){Ext.Ajax.request({url:"/greent/app/updates_server.cfg",success:function(e){checkForUpdates(e.responseText)},failure:function(e){alert("Error connecting update server!")}})}function checkForUpdates(e){Ext.data.JsonP.request({url:e+"/check.php?version="+oph_greenT_build,callbackKey:"callback",success:function(e,t){if(e.status==true){oph_update_available=e.needsUpdate;oph_update_version=e.lastBuildName;oph_update_build=e.lastBuildNumber;oph_update_info=e.info;if(OpenHAB.enableUpdates=="true"){if(e.needsUpdate==true){var n=confirm("GreenT UI version "+e.lastBuildName+" is available. Do you want to update now?");if(n){if(!settingsPanel){showSettingsWindow();settingsPanel.setActiveItem(2)}else{settingsPanel.setActiveItem(2)}}}}}else{alert("Error reading update server!")}}})}function updateWidgets(e){if(Ext.isArray(e.widget)){for(var t=0 in e.widget){if(e.widget[t].type=="Frame"){if(Ext.isArray(e.widget[t].widget)){for(var n=0 in e.widget[t].widget){setWidgetData(e.widget[t].widget[n])}}else{setWidgetData(e.widget[t].widget)}}else{setWidgetData(e.widget[t])}}}else{setWidgetData(e.widget)}if(deviceType!="Phone"){if(e.parent&&e.parent.id==currentLeftNavPage){setTitle(e.title);updateLeftNavMenuItem(e.id,e.title,e.icon)}else if(e.id==currentLeftNavPage){refreshTitle()}else{refreshTitle()}}else{setTitle(e.title)}}function getLocalStoreItem(e,t){var n=localStorage.getItem(e);if(!n||n=="null"){return t}else{return n}}function setTheme(){var e=getLocalStoreItem("openHAB_theme","GreenT");if(OpenHAB.themes.indexOf(e)==-1){e="GreenT"}theme_css_filename="./themes/"+e+"/css/style.css";var t=document.createElement("link");t.setAttribute("rel","stylesheet");t.setAttribute("type","text/css");t.setAttribute("href",theme_css_filename);document.getElementsByTagName("head")[0].appendChild(t)}function getCurrentPageId(){return broadCrumb[broadCrumb.length-1][0]}function readUpdateLog(){Ext.Ajax.request({url:"/greent/update.tmp",success:function(e){settingsPanel.getItems().items[2].getItems().items[1].setHtml(e.responseText);Ext.defer(readUpdateLog,3e3,this)},failure:function(e){Ext.defer(readUpdateLog,3e3,this)}})}function loadUIData(e){Ext.getCmp("content").setMasked({xtype:"loadmask",message:OpenHAB.i18n_strings[ui_language].loading});Ext.Ajax.request({url:"/rest/sitemaps/"+e,headers:{Accept:"application/json"},success:function(t){try{result=Ext.JSON.decode(t.responseText)}catch(n){loadUIData(e);return}buildUIArray(result.homepage,UInavPanel);clearEmptyFrames();Ext.getCmp("content").unmask();broadCrumb[0]=new Array(result.homepage.id,result.homepage.title);Ext.getCmp("title").setHtml(result.homepage.title);goToPage(result.homepage.id);if(Ext.getCmp("leftPanel")){leftPanelstore.setRoot(UInavPanel);setCurrentLeftNavPage(result.homepage.id)}Ext.getCmp("content").unmask()},failure:function(){alert(OpenHAB.i18n_strings[ui_language].error_server_connection)}})}function pushWidget(e,t){if(e){t.push(e)}}function buildUIArray(e,t){try{if(e){var n;UIobjects[e.id]=new Array;n=UIobjects[e.id];var r=e.widget;if(Ext.isArray(r)){var i=false;for(var s in r){if(r[s].type!="Frame"){if(!i){n.push({xtype:"fieldset",title:"",cls:["oph_fieldset",deviceTypeCls+"_fieldset","oph_clearfix"]});n=n[n.length-1]["items"]=new Array;i=true}pushWidget(addsWidget(r[s].widgetId,r[s],n,t),n)}else if(r[s].type=="Frame"){i=false;n.push({xtype:"fieldset",title:r[s].label,cls:["oph_fieldset",deviceTypeCls+"_fieldset","oph_clearfix"]});n[n.length-1]["items"]=new Array;if(Ext.isArray(r[s].widget)){for(var o in r[s].widget){pushWidget(addsWidget(r[s].widget[o].widgetId,r[s].widget[o],n[n.length-1]["items"],t),n[n.length-1]["items"])}}else{pushWidget(addsWidget(r[s].widget.widgetId,r[s].widget,n[n.length-1]["items"],t),n[n.length-1]["items"])}}}}else{if(r.type!="Frame"){n.push({xtype:"fieldset",title:"",cls:["oph_fieldset",deviceTypeCls+"_fieldset","oph_clearfix"]});n=n[n.length-1]["items"]=new Array;pushWidget(addsWidget(r.widgetId,r,n,t),n)}else if(r.type=="Frame"){n.push({xtype:"fieldset",title:r.label,cls:["oph_fieldset",deviceTypeCls+"_fieldset","oph_clearfix"]});n[n.length-1]["items"]=new Array;if(Ext.isArray(r.widget)){for(var o in r.widget){pushWidget(addsWidget(r.widget[o].widgetId,r.widget[o],n[n.length-1]["items"],t),n[n.length-1]["items"])}}else{pushWidget(addsWidget(r.widget.widgetId,r.widget,n[n.length-1]["items"],t),n[n.length-1]["items"])}}}}}catch(u){alert(OpenHAB.i18n_strings[ui_language].error_build_interface)}}function clearEmptyFrames(){for(var e in UIobjects){var t=[];for(var n in UIobjects[e]){if(UIobjects[e][n].items.length>0){t.push(UIobjects[e][n])}}UIobjects[e]=t}}function addsWidget(e,t,n,r){var i;var s;if(t.type=="Switch"){if(t.item&&t.item.type=="RollershutterItem"){i=createRollershutterWidget(t.item?t.item.name:"",t.label,t.icon)}else if(t.item&&t.item.type=="NumberItem"){i=createButtonsWidget(t.item?t.item.name:"",t.mapping,t.label,t.icon)}else if(t.item&&t.item.type=="SwitchItem"&&t.mapping){i=createButtonsWidget(t.item?t.item.name:"",t.mapping,t.label,t.icon)}else if(t.item&&t.item.type=="GroupItem"&&t.mapping){i=createButtonsWidget(t.item?t.item.name:"",t.mapping,t.label,t.icon)}else{i=createToggleWidget(t.item?t.item.name:"",t.label,t.icon)}}else if(t.type=="Slider"){i=createSliderWidget(t.item?t.item.name:"",t.label,t.icon)}else if(t.type=="Setpoint"){i=createSetpointWidget(t.item?t.item.name:"",t.minValue,t.maxValue,t.step,t.label,t.icon)}else if(t.type=="Video"){i=createVideoWidget(t.item?t.item.name:"",t.url,t.label,t.icon)}else if(t.type=="Webview"){i=createWebviewWidget(t.item?t.item.name:"",t.url,t.height,t.label,t.icon)}else if(t.type=="Chart"){i=createChartWidget(t.item?t.item.name:"",e,t.w,t.h,t.period,t.refresh,t.item?t.item.type:"",t.label,t.icon)}else if(t.type=="Text"){if(t.linkedPage){if(deviceType=="Phone"){i=createLinkWidget(t)}else{s=addButtonToLeftNav(e,t,r)}buildUIArray(t.linkedPage,s)}else{i=createTextWidget(t.label,t.icon)}}else if(t.type=="Group"){if(deviceType=="Phone"){i=createLinkWidget(t)}else{s=addButtonToLeftNav(e,t,r)}buildUIArray(t.linkedPage,s)}else if(t.type=="Selection"){i=createSelectionWidget(t.item?t.item.name:"",t.mapping,t.label,t.icon)}else if(t.type=="Image"){if(t.linkedPage){if(deviceType=="Phone"){i=createImageLinkWidget(t.url,t.linkedPage.id,t.linkedPage.title)}else{s=addButtonToLeftNav(e,t,r);i=createImageLinkWidget(t.url,t.linkedPage.id,t.linkedPage.title)}buildUIArray(t.linkedPage,s)}else{i=createImageWidget(t.url)}}else if(t.type=="Frame"){}else{i=createUnsupportedWidget()}if(i){i.name=e}return i}function addButtonToLeftNav(e,t,n){if(t.linkedPage){page_id=t.linkedPage.id}else{page_id="none"}pushWidget({icon:t.icon,text:t.label.replace(/[\[\]']+/g,""),page_id:page_id,page_label:t.label,leaf:true,name:e,id:e},n.children);n.leaf=false;n.children[n.children.length-1].children=new Array;return n.children[n.children.length-1]}function showSettingsWindow(){if(settingsPanel){settingsPanel.destroy();settingsPanel=null}else{settingsPanel=new Ext.Panel(settingsWindow);settingsPanel.setCls(deviceTypeCls+"_modal");settingsPanel.getItems().items[0].getItems().items[1].setValue(getLocalStoreItem("openHAB_sitemap","choose"));settingsPanel.getItems().items[0].getItems().items[2].setValue(getLocalStoreItem("openHAB_device_type","auto"));var e=new Array;for(var t in OpenHAB.i18n_strings){e.push({text:OpenHAB.i18n_strings[t].language_name,value:t})}settingsPanel.getItems().items[0].getItems().items[3].setOptions(e);settingsPanel.getItems().items[0].getItems().items[3].setValue(getLocalStoreItem("openHAB_language","en"));e=[];for(var t in OpenHAB.themes){e.push({text:OpenHAB.themes[t],value:OpenHAB.themes[t]})}settingsPanel.getItems().items[0].getItems().items[4].setOptions(e);settingsPanel.getItems().items[0].getItems().items[4].setValue(getLocalStoreItem("openHAB_theme","GreenT"));settingsPanel.getItems().items[0].getItems().items[5].setOptions([{text:OpenHAB.i18n_strings[ui_language].auto_detect,value:"auto"},{text:"Websockets",value:"websocket"},{text:"HTTP Streaming",value:"streaming"},{text:"HTTP Long-polling",value:"long-polling"}]);settingsPanel.getItems().items[0].getItems().items[5].setValue(getLocalStoreItem("openHAB_transport","auto"));settingsPanel.getItems().items[0].getItems().items[6].setValue(transitions);logo_width=50;if(deviceType=="Phone"){logo_width=85}update_link="";if(OpenHAB.enableUpdates=="true"||OpenHAB.enableUpdates=="password"){if(oph_update_available){update_link=' <i>(<a href="#" style="color:red" id="update_button">UPDATE</a>)</i>'}else{update_link=" <i>(up to date)</i>"}}settingsPanel.getItems().items[1].getItems().items[1].setHtml('<div style="text-align:center;font-size:1em;"><img style="width:'+logo_width+'%;margin:1em;" src="./app/logo.png" border="0"/><br><b>GreenT UI installed version:</b> '+oph_greenT_version+"<br><b>GreenT UI available version:</b> "+oph_update_version+update_link+"<br><b>openHAB version:</b> "+oph_openHAB_version+"<br><br><b>Transport Protocol:</b> "+detectedTransport+'<br><a style="color:#87a600;" target="_blank" href="http://m-design.bg/greent/">GreenT UI Website</a></div>');settingsPanel.getItems().items[2].getItems().items[1].setHtml('<div style="padding-top:0.5em;text-align:center;font-size:1em;"><b>Installed version:</b> '+oph_greenT_version+" <i>(build "+oph_greenT_build+")</i><br><b>Version to update: </b>"+oph_update_version+" <i>(build "+oph_update_build+")</i><br><br><b>Update info:</b><br>"+oph_update_info+"</div><br><br>");Ext.Viewport.add(settingsPanel);try{Ext.get("update_button").clearListeners();Ext.get("update_button").on("tap",function(){if(OpenHAB.enableUpdates=="password"){var e=prompt("Enter a password:","");if(e==OpenHAB.updatesPassword){settingsPanel.setActiveItem(2)}else{alert("Wrong password!")}}else if(OpenHAB.enableUpdates=="true"){settingsPanel.setActiveItem(2)}})}catch(n){}dirtySettings=false}}function NavBarItemTap(e,t,n,r,i){if(i.raw.page_id=="none"){return}leftNavPanel.getBackButton().show();if(i.raw.leaf){if(clickOnLeaf){broadCrumb.pop()}clickOnLeaf=true}else{if(clickOnLeaf){broadCrumb.pop()}clickOnLeaf=false;setCurrentLeftNavPage(i.raw.page_id)}broadCrumb.push([i.raw.page_id,i.raw.page_label]);if(UIobjects[i.raw.page_id].length>0){goToPage(i.raw.page_id)}}function tapHandler(e,t){if(e.config.page_id=="none"){return}e.addCls("selected");if(deviceType=="Phone"){broadCrumb.push([e.config.page_id,e.config.page_label]);transition={type:"slide",direction:"left"};goToPage(e.config.page_id)}else{leftNav=Ext.getCmp("leftPanel").getActiveItem();index=leftNav.getStore().getAt(leftNav.getStore().find("page_id",e.config.page_id)).data.index;leftNav.select(index,false,false);NavBarItemTap(leftNav,"",index,"",leftNav.getStore().getAt(leftNav.getStore().find("page_id",e.config.page_id)))}}function backPage(){if(broadCrumb.length>1){broadCrumb.pop();transition={type:"slide",direction:"right"};goToPage(broadCrumb[broadCrumb.length-1][0])}}function goToPage(e){newCard=new Oph.form.Panel({scrollable:"vertical",autoDestroy:true,cls:["oph_widgets_container",deviceTypeCls+"_widgets_container"]});newCard.add(UIobjects[e]);if(transitions=="0"){Ext.getCmp("content").setActiveItem(newCard)}else if(transitions=="1"){Ext.getCmp("content").animateActiveItem(newCard,transition)}}function updateWidgetsAjax(e,t){if(e==getCurrentPageId()){var n="";var r=5e3;if(!t||t=="normal"){n={Accept:"application/json"}}else if(t=="long-poll"){unsubscribe();subscribe("/rest/sitemaps/"+sitemap+"/"+e);return}for(var i=ajax_requests.length-1;i>=0;i--){if(ajax_requests.hasOwnProperty(i)){Ext.Ajax.abort(ajax_requests[i]);ajax_requests.pop()}}req=Ext.Ajax.request({url:"/rest/sitemaps/"+sitemap+"/"+e,headers:n,disableCaching:true,timeout:r,failure:function(n){if(t=="long-poll"){updateWidgetsAjax(e,"long-poll")}else{updateWidgetsAjax(e,"normal")}},success:function(t){if(t.statusText=="OK"&&t.responseText!=""){try{var n=Ext.JSON.decode(t.responseText)}catch(r){updateWidgetsAjax(e,"normal");return}updateWidgets(n);updateWidgetsAjax(e,"long-poll")}else{}}});ajax_requests.push(req)}}function setWidgetData(e){if(current_widgets[e.widgetId]){current_widgets[e.widgetId].setValueData(e)}else{if(deviceType!="Phone"){updateLeftNavMenu(e)}}}function updateLeftNavMenuItem(e,t,n){nav_store=Ext.getCmp("leftPanel").getActiveItem().getStore();index=nav_store.find("page_id",e);if(index!=-1){nav_store.getAt(index).set("text",t.replace(/[\[\]']+/g,""));nav_store.getAt(index).set("icon",n)}}function updateLeftNavMenu(e){nav_store=Ext.getCmp("leftPanel").getActiveItem().getStore();index=nav_store.find("name",e.widgetId);if(index!=-1){nav_store.getAt(index).set("text",e.label.replace(/[\[\]']+/g,""));nav_store.getAt(index).set("icon",e.icon)}}function setProfile(){if(force_transport=="auto"){force_transport="websocket";fallbackProtocol="streaming";if(Ext.os.is.Android2){fallbackProtocol="long-polling"}}else{fallbackProtocol=force_transport}oph_usepicker="auto";deviceType=localStorage.getItem("openHAB_device_type");if(deviceType&&deviceType!="Auto"){}else{deviceType=Ext.os.deviceType}if(deviceType=="Phone"){deviceTypeCls="oph_phone";oph_usepicker=true}else if(deviceType=="Tablet"){deviceTypeCls="oph_tablet";oph_usepicker=false}else{deviceTypeCls="oph_desktop";oph_usepicker=false}}function sendCommand(e,t){if(e){Ext.Ajax.request({comm_method:"ajax",url:"/rest/items/"+e+"/",method:"POST",params:t,headers:{"Content-Type":"text/plain"},failure:function(){}})}}function createSliderWidget(e,t,n){return{xtype:"oph_sliderfield",minValue:0,maxValue:100,oph_item:e,label:'<div class="'+icon_class+'" style="'+icon_style+"(/images/"+n+'.png);"></div><div class="oph_label">'+t.replace(/[\[\]']+/g,"")+"</div>"}}function createTextWidget(e,t){return{xtype:"oph_textfield",html:e.match(/\[(.*?)\]/)?e.match(/\[(.*?)\]/)[1]:e,label:'<div class="'+icon_class+'" style="'+icon_style+"(/images/"+t+'.png);"></div><div class="oph_label">'+e.replace(/\[(.*?)\]/,"")+"</div>"}}function createToggleWidget(e,t,n){return{xtype:"oph_togglefield",oph_item:e,label:'<div class="'+icon_class+'" style="'+icon_style+"(/images/"+n+'.png);"></div><div class="oph_label">'+t.replace(/[\[\]']+/g,"")+"</div>"}}function createRollershutterWidget(e,t,n){return{xtype:"oph_rollershutterfield",oph_item:e,label:'<div class="'+icon_class+'" style="'+icon_style+"(/images/"+n+'.png);"></div><div class="oph_label">'+t.replace(/[\[\]']+/g,"")+"</div>"}}function createLinkWidget(e){page_label=e.label;if(e.linkedPage){page_id=e.linkedPage.id}else{page_id="none"}return{xtype:"oph_buttonfield",page_id:page_id,page_label:page_label}}function createImageLinkWidget(e,t,n){return{xtype:"oph_imagelink",url:e,page_id:t,page_label:n}}function createSelectionWidget(e,t,n,r){return{xtype:"oph_selectfield",options:t,oph_item:e,usePicker:oph_usepicker,label:'<div class="'+icon_class+'" style="'+icon_style+"(/images/"+r+'.png);"></div><div class="oph_label">'+n.replace(/[\[\]']+/g,"")+"</div>"}}function createSetpointWidget(e,t,n,r,i,s){return{xtype:"oph_setpointfield",oph_item:e,minValue:Number(t),maxValue:Number(n),increment:Number(r),defaultValue:t,cycle:false,label:'<div class="'+icon_class+'" style="'+icon_style+"(/images/"+s+'.png);"></div><div class="oph_label">'+i.replace(/[\[\]']+/g,"")+"</div>"}}function createVideoWidget(e,t,n,r){return{xtype:"oph_videofield",oph_item:e,url:t,width:"100%",height:"16em",style:"background-color:white;",posterUrl:"./app/video.png",oph_label:n}}function createWebviewWidget(e,t,n,r,i){return{xtype:"oph_webviewfield",oph_item:e,url:t,width:"100%",height:"16em",oph_label:r,oph_height:n}}function createButtonsWidget(e,t,n,r){return{xtype:"oph_buttons_selectfield",options:t,oph_item:e,label:'<div class="'+icon_class+'" style="'+icon_style+"(/images/"+r+'.png);"></div><div class="oph_label">'+n.replace(/[\[\]']+/g,"")+"</div>"}}function createUnsupportedWidget(){return{xtype:"field",label:"[UNSUPPORTED WIDGET]"}}function createImageWidget(e){return{xtype:"oph_imagefield",url:e,cls:"x-image-field"}}function createChartWidget(e,t,n,r,i,s,o,u,a){return{xtype:"oph_chartfield",oph_item:e,oph_w:n,oph_h:r,oph_period:i,oph_refresh:s,oph_id:t,oph_type:o,img_src:""}}function setTitle(e){broadCrumb[broadCrumb.length-1][1]=e;refreshTitle()}function refreshTitle(){if(deviceType=="Phone"){if(broadCrumb.length==1){Ext.getCmp("back_btn").hide()}else{Ext.getCmp("back_btn").show()}broadCrumbText=broadCrumb[broadCrumb.length-1][1].replace(/[\[\]']+/g,"")}else{broadCrumbText="";for(var e in broadCrumb){broadCrumbText+=broadCrumb[e][1].replace(/[\[\]']+/g,"");if(e!=broadCrumb.length-1){broadCrumbText+=" > "}}}Ext.getCmp("title").setHtml(broadCrumbText)}function setCurrentLeftNavPage(e){currentLeftNavPage=e}var oph_greenT_version="1.0.0";var oph_greenT_build="1002";var oph_openHAB_version="not known";var oph_update_available=false;var oph_update_version;var oph_update_build;var oph_update_info;var firstload=true;var detectedTransport=null;var socket=$.atmosphere;var fallbackProtocol=null;var current_widgets;var UIobjects={};var UInavPanel={expanded:true,text:"Left nav",children:[]};var ajax_requests=new Array;var broadCrumb=new Array;var broadCrumbText="";var newCard;var settingsPanel=null;var updateModel={};var deviceTypeCls="";var deviceType;var clickOnLeaf=false;var firstTime=true;var sitemap;var currentLeftNavPage;var leftNavPanel;var sitemapUIcontainer;var transition={type:"slide",direction:"left"};var sitemapsPanel;var icon_class="oph_icon";var icon_style="background-image:url";var oph_usepicker;var dirtySettings=false;var ui_language=getLocalStoreItem("openHAB_language","en");var transitions=getLocalStoreItem("openHAB_transitions","1");var force_transport=getLocalStoreItem("openHAB_transport","auto");var sitemapStoreLoadTries=3;var sitemapsStoreSelection=new Ext.data.Store({fields:["name","value"],autoLoad:true});var sitemapsStore=new Ext.data.Store({fields:["name","value"],autoLoad:true,listeners:{exception:function(e,t,n,r){if(sitemapStoreLoadTries>0){sitemapsStore.load();sitemapStoreLoadTries--}else{sitemapStoreLoadTries=3;alert(OpenHAB.i18n_strings[ui_language].error_server_connection)}},load:function(e,t,n){if(n){for(record in t){t[record].data.value=t[record].data.name}sitemapStoreLoadTries=3;sitemapsStoreSelection.insert(0,[{name:"- "+OpenHAB.i18n_strings[ui_language].choose_on_startup,value:"choose"}]);sitemapsStore.each(function(e){sitemapsStoreSelection.add(e.copy())})}else{if(sitemapStoreLoadTries>0){sitemapsStore.load();sitemapStoreLoadTries--}else{sitemapStoreLoadTries=3;alert(OpenHAB.i18n_strings[ui_language].error_server_connection)}}}},proxy:{type:"ajax",url:"/rest/sitemaps",headers:{Accept:"application/json"},noCache:true,limitParam:undefined,startParam:undefined,pageParam:undefined,reader:{type:"json",rootProperty:"sitemap"}}});var sitemapsWindow={id:"sitemapsWindow",floating:true,centered:true,layout:"fit",scrollable:false,items:[{title:OpenHAB.i18n_strings[ui_language].interfaces,xtype:"toolbar",ui:"light",docked:"top"},{xtype:"list",store:sitemapsStore,singleSelect:true,itemTpl:"{name}",scrollable:false,listeners:{itemtap:function(e,t,n,r){sitemap=r.data.name;loadUIData(sitemap);sitemapsPanel.destroy()}}}]};var settingsWindow={id:"settingsWindow",floating:true,centered:true,layout:"card",items:[{scrollable:"vertical",items:[{xtype:"toolbar",ui:"light",docked:"top",items:[{xtype:"spacer"},{xtype:"label",cls:"x-title",centered:true,zIndex:0,html:OpenHAB.i18n_strings[ui_language].settings},{xtype:"spacer"},{iconCls:"delete",iconMask:true,ui:"normal",handler:function(){if(dirtySettings){localStorage.setItem("openHAB_sitemap",settingsPanel.getItems().items[0].getItems().items[1].getValue());localStorage.setItem("openHAB_device_type",settingsPanel.getItems().items[0].getItems().items[2].getValue());localStorage.setItem("openHAB_language",settingsPanel.getItems().items[0].getItems().items[3].getValue());localStorage.setItem("openHAB_theme",settingsPanel.getItems().items[0].getItems().items[4].getValue());localStorage.setItem("openHAB_transport",settingsPanel.getItems().items[0].getItems().items[5].getValue());localStorage.setItem("openHAB_transitions",settingsPanel.getItems().items[0].getItems().items[6].getValue());alert(OpenHAB.i18n_strings[ui_language].need_to_restart_for_changes_to_take_effect);window.location.reload()}settingsPanel.destroy();settingsPanel=null}}]},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].default_sitemap,labelWidth:"40%",store:sitemapsStoreSelection,displayField:"name",valueField:"value",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true}}},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].this_device_is,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true}},options:[{text:OpenHAB.i18n_strings[ui_language].auto_detect,value:"Auto"},{text:OpenHAB.i18n_strings[ui_language].phone,value:"Phone"},{text:OpenHAB.i18n_strings[ui_language].tablet,value:"Tablet"},{text:OpenHAB.i18n_strings[ui_language].pc,value:"Desktop"}]},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].interface_language,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true}}},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].theme,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true}}},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].transport_protocol,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true}}},{xtype:"togglefield",label:OpenHAB.i18n_strings[ui_language].transitions,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true}}},{xtype:"button",text:'<img style="height:100%;" src="./app/logo_tr.png" border="0" />',style:"clear:both;margin:0.7em 5%;height:3.6em;",scope:this,cls:"oph_about_btn",handler:function(){settingsPanel.setActiveItem(1)}}]},{cls:"oph_about_page",scrollable:"vertical",items:[{xtype:"toolbar",ui:"light",docked:"top",items:[{ui:"back",text:OpenHAB.i18n_strings[ui_language].back,handler:function(){settingsPanel.setActiveItem(0)}},{xtype:"spacer"},{xtype:"label",cls:"x-title",centered:true,zIndex:0,html:"GreenT UI"},{xtype:"spacer"},{iconCls:"delete",iconMask:true,ui:"normal",handler:function(){settingsPanel.destroy();settingsPanel=null}}]},{xtype:"container",cls:"oph_about_page_content"}]},{cls:"oph_update_page",scrollable:"vertical",items:[{xtype:"toolbar",ui:"light",docked:"top",items:[{ui:"back",text:OpenHAB.i18n_strings[ui_language].back,handler:function(){settingsPanel.setActiveItem(1)}},{xtype:"spacer"},{xtype:"label",cls:"x-title",centered:true,zIndex:0,html:"GreenT UI Update"},{xtype:"spacer"},{iconCls:"delete",iconMask:true,ui:"normal",handler:function(){settingsPanel.destroy();settingsPanel=null}}]},{xtype:"container",cls:"oph_about_page_content"},{xtype:"button",text:"Update GreenT UI",scope:this,style:"margin:0.8em 5%;height:3em;",ui:"confirm",handler:function(e){settingsPanel.getItems().items[2].getItems().items[2].destroy();sendCommand("update_greent","ON");settingsPanel.getItems().items[2].getItems().items[1].setHtml("");Ext.defer(readUpdateLog,3e3,this)}}]}]};Ext.define("LeftPanelListItem",{extend:"Ext.data.Model",config:{fields:[{name:"icon",type:"string"},{name:"text",type:"string"},{name:"page_id",type:"string"},{name:"page_label",type:"string"},{name:"name",type:"string"}]}});var leftPanelstore=new Ext.data.TreeStore({model:"LeftPanelListItem",autoLoad:false,proxy:{type:"memory",reader:{type:"json",rootProperty:"children"}}});Ext.define("Oph.field.ButtonsSelect",{extend:"Ext.field.Field",xtype:"oph_buttons_selectfield",config:{cls:"x-buttons-field",styleHtmlContent:true,styleHtmlCls:"oph_none",labelWidth:"50%"},constructor:function(e){e=e||{};this.callParent([e])},applyComponent:function(e){component=this;container=Ext.factory({styleHtmlContent:true,styleHtmlCls:"oph_right"},Ext.Container);if(Ext.isArray(this.config.options)){for(var t in this.config.options){item=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_selection_btn",item:component.config.oph_item,command:component.config.options[t].command,text:this.config.options[t].label}));item.on({tap:function(){sendCommand(this.config.item,this.config.command)}})}}else{item=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_selection_btn",item:component.config.oph_item,command:component.config.options.command,text:this.config.options.label}));item.on({tap:function(){sendCommand(this.config.item,this.config.command)}})}return container},initialize:function(){this.callParent()},setValueData:function(e){this.setLabel('<div class="'+icon_class+'" style="'+icon_style+"(/images/"+e.icon+'.png);"></div><div class="oph_label">'+e.label.replace(/[\[\]']+/g,"")+"</div>");if(Ext.isArray(e.mapping)){for(var t in e.mapping){this._component._items.items[t].removeCls("x-button-action");if(e.item.state==e.mapping[t].command){this._component._items.items[t].addCls("x-button-action")}}}else{this._component._items.items[0].addCls("x-button-action")}}});Ext.define("Oph.field.Slider",{extend:"Ext.field.Slider",xtype:"oph_sliderfield",config:{labelWidth:"50%"},constructor:function(e){e=e||{};this.callParent([e])},initialize:function(){this.callParent();this.on({painted:function(e){e._component.element.on({tap:function(){sendCommand(e.config.oph_item,e.getValue())}});e._component.getThumb(0).element.on({dragend:function(){sendCommand(e.config.oph_item,e.getValue())}})}})},setValueData:function(e){if(e.item){this.setValue(e.item.state)}this.setLabel('<div class="'+icon_class+'" style="'+icon_style+"(/images/"+e.icon+'.png);"></div><div class="oph_label">'+e.label.replace(/[\[\]']+/g,"")+"</div>");return this}});Ext.define("Oph.field.Setpoint",{extend:"Ext.field.Spinner",xtype:"oph_setpointfield",config:{labelWidth:"50%"},constructor:function(e){e=e||{};this.callParent([e])},initialize:function(){this.callParent();this.on({spindown:function(e,t){sendCommand(e.config.oph_item,t)},spinup:function(e,t){sendCommand(e.config.oph_item,t)}})},setValueData:function(e){if(e.item){if(e.item.state=="Uninitialized"){this.setValue(Number(this.config.minValue))}else{this.setValue(Number(e.item.state))}}this.setLabel('<div class="'+icon_class+'" style="'+icon_style+"(/images/"+e.icon+'.png);"></div><div class="oph_label">'+e.label.replace(/[\[\]']+/g,"")+"</div>");return this}});Ext.define("Oph.field.Select",{extend:"Ext.field.Select",xtype:"oph_selectfield",config:{displayField:"label",valueField:"command",labelWidth:"50%"},constructor:function(e){e=e||{};this.callParent([e])},initialize:function(){this.callParent();this.on({painted:function(e){e.on({selected:function(){sendCommand(e.config.oph_item,e.getValue())}})}})},setValueData:function(e){if(e.item){this.setValue(e.item.state)}this.setLabel('<div class="'+icon_class+'" style="'+icon_style+"(/images/"+e.icon+'.png);"></div><div class="oph_label">'+e.label.replace(/[\[\]']+/g,"")+"</div>");return this},onListSelect:function(e,t){var n=this;if(t){n.setValue(t);this.fireEvent("selected",this)}},onPickerChange:function(e,t){var n=this,r=n.getValue(),i=t[n.getName()],s=n.getStore(),o=s.find(n.getValueField(),i);record=s.getAt(o);n.setValue(record);this.fireEvent("selected",this)}});Ext.define("Oph.field.Text",{extend:"Ext.field.Field",xtype:"oph_textfield",config:{cls:"x-textfield",styleHtmlContent:true,styleHtmlCls:"oph_none",labelWidth:"50%"},constructor:function(e){e=e||{};this.callParent([e])},initialize:function(){this.callParent()},setValueData:function(e){this.setHtml(e.label.match(/\[(.*?)\]/)?e.label.match(/\[(.*?)\]/)[1]:e.label);this.setLabel('<div class="'+icon_class+'" style="'+icon_style+"(/images/"+e.icon+'.png);"></div><div class="oph_label">'+e.label.replace(/\[(.*?)\]/,"")+"</div>");return this}});Ext.define("Oph.field.Toggle",{extend:"Ext.field.Toggle",xtype:"oph_togglefield",config:{labelWidth:"50%"},constructor:function(e){e=e||{};this.callParent([e])},initialize:function(){this.callParent();this.on({painted:function(e){e._component.element.on({singletap:function(){sendCommand(e.config.oph_item,e.formatOutputValue(e.getValue()))}});e._component.getThumb(0).element.on({dragend:function(){sendCommand(e.config.oph_item,e.formatOutputValue(e.getValue()))}})}})},setValueData:function(e){if(e.item){this.setValue(this.formatInputValue(e.item.state))}this.setLabel('<div class="'+icon_class+'" style="'+icon_style+"(/images/"+e.icon+'.png);"></div><div class="oph_label">'+e.label.replace(/[\[\]']+/g,"")+"</div>");return this},formatInputValue:function(e){if(e=="ON"){return 1}else{return 0}},formatOutputValue:function(e){if(e==1){return"ON"}else if(e==0){return"OFF"}}});Ext.define("Oph.field.Rollershutter",{extend:"Ext.field.Field",xtype:"oph_rollershutterfield",config:{cls:"x-rollershutter-field",styleHtmlContent:true,styleHtmlCls:"oph_none",labelWidth:"50%"},constructor:function(e){e=e||{};this.callParent([e])},applyComponent:function(e){component=this;container=Ext.factory({styleHtmlContent:true,styleHtmlCls:"oph_right"},Ext.Container);but1=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_rollershutter_btn",longPress:false,iconCls:"arrow_up",iconMask:true}));but1.element.item=component.config.oph_item;but1.element.on({touchstart:function(){sendCommand(this.item,"UP")},longpress:function(){but1.longPress=true},tap:function(){if(but1.longPress){but1.longPress=false;sendCommand(this.item,"STOP")}}});but2=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_rollershutter_btn",iconCls:"delete",iconMask:true}));but2.element.item=component.config.oph_item;but2.element.on({tap:function(){sendCommand(this.item,"STOP")}});but3=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_rollershutter_btn",longPress:false,iconCls:"arrow_down",iconMask:true}));but3.element.item=component.config.oph_item;but3.element.on({touchstart:function(){sendCommand(this.item,"DOWN")},longpress:function(){but3.longPress=true},tap:function(){if(but3.longPress){but3.longPress=false;sendCommand(this.item,"STOP")}}});return container},initialize:function(){this.callParent()},initialize:function(){this.callParent()},setValueData:function(e){this.setLabel('<div class="'+icon_class+'" style="'+icon_style+"(/images/"+e.icon+'.png);"></div><div class="oph_label">'+e.label.replace(/[\[\]']+/g,"")+"</div>");return this}});Ext.define("Oph.field.Button",{extend:"Ext.Button",xtype:"oph_buttonfield",isField:true,config:{style:"display:block",baseCls:"x-field oph_group_btn oph_button",labelCls:"",isField:true,cls:"oph_link"},constructor:function(e){e=e||{};this.callParent([e])},initialize:function(){this.callParent()},setValueData:function(e){this.setHtml('<div class="'+icon_class+'" style="'+icon_style+"(/images/"+e.icon+'.png);"></div><div class="oph_label">'+e.label.replace(/[\[\]']+/g,"")+'</div><span class="arrow"></span>');return this},getName:function(){return this.config.name}});Ext.define("Oph.field.Webview",{extend:"Ext.Container",xtype:"oph_webviewfield",constructor:function(e){e=e||{};this.callParent([e]);var t=58*Number(e.oph_height);if(deviceType=="Phone"){t=52*Number(e.oph_height)}this.setHeight(t+18);this.setStyle("position:relative;padding:0.4em;");this.setHtml('<div class="oph_webview_mask" style="z-index:999;position:absolute;top:0;left:0;width:100%;height:'+t+'px;"></div>		<div style="position:absolute;top:0;left:0;overflow:hidden;height:'+Number(t+20)+'px;width:100%;"><iframe scrolling="no" src="'+e.url+'" width="100%" height='+t+' style="border:1px solid gray;"></iframe></div>')},initialize:function(){this.callParent()},setValueData:function(e){}});Ext.define("Oph.field.Video",{extend:"Ext.Video",xtype:"oph_videofield",constructor:function(e){e=e||{};this.callParent([e]);if(e.url.substr(0,4)!="http"&&e.url.substr(0,1)!="/"){e.url="/"+e.url}},initialize:function(){this.callParent();this.ghost.setHtml('<div style="text-align:center;padding-top:1em;">'+this.config.oph_label+"</div>")},setValueData:function(e){}});Ext.define("Oph.field.Chart",{extend:"Ext.Container",xtype:"oph_chartfield",refreshInterval:null,constructor:function(e){e=e||{};var t="items";if(e.oph_type=="GroupItem"){t="groups"}e.img_src="/rrdchart.png?"+t+"="+e.oph_item+"&period="+e.oph_period;this.callParent([e]);this.setHtml('<div style="width:100%;padding:0.4em;"><img id="img'+e.oph_id+'" src="'+e.img_src+"&random="+(new Date).getTime()+'" style="width:100%;"></div>')},initialize:function(){this.callParent();this.on({painted:function(e){if(e.config.oph_refresh>0){e.config.refreshInterval=window.setInterval(function(){e.updateImage(e)},e.config.oph_refresh)}},erased:function(e){if(e.config.oph_refresh>0){window.clearInterval(e.config.refreshInterval)}}})},setValueData:function(e){},updateImage:function(e){Ext.fly("img"+e.config.oph_id).dom.src=e.config.img_src+"&random="+(new Date).getTime()}});Ext.define("Oph.field.Image",{extend:"Ext.Container",xtype:"oph_imagefield",constructor:function(e){e=e||{};this.callParent([e]);if(e.url.substr(0,4)!="http"&&e.url.substr(0,1)!="/"){e.url="/"+e.url}this.setHtml('<div style="width:100%;padding:0.4em;"><img src="'+e.url+'" style="width:100%;"></div>')},initialize:function(){this.callParent()},setValueData:function(e){}});Ext.define("Oph.field.ImageLink",{extend:"Ext.Button",xtype:"oph_imagelink",config:{style:"display:block",baseCls:"none",labelCls:"",cls:"oph_link"},constructor:function(e){e=e||{};this.callParent([e]);if(e.url.substr(0,4)!="http"&&e.url.substr(0,1)!="/"){e.url="/"+e.url}this.setHtml('<div style="width:100%;padding:0.4em;"><img src="'+e.url+'" style="width:100%;"></div>')},initialize:function(){this.callParent()},setValueData:function(e){}});Ext.define("Oph.form.Panel",{extend:"Ext.Panel",xtype:"oph_formpanel",constructor:function(e){e=e||{};this.callParent([e])},initialize:function(){this.callParent()},setValuesData:function(e){var t=this.getFields(),n,r,i;e=e||{};for(n in e){if(e.hasOwnProperty(n)){r=t[n];i=e[n];if(r){r.setValueData(i)}}}return this},getFields:function(e){var t={},n;var r=function(i){if(i.isField){n=i.getName();if(e&&n==e||typeof e=="undefined"){if(t.hasOwnProperty(n)){if(!Ext.isArray(t[n])){t[n]=[t[n]]}t[n].push(i)}else{t[n]=i}}}if(i.isContainer){i.items.each(r)}};this.items.each(r);return e?t[e]||[]:t}});var oph_app=Ext.application({name:"OpenHAB",icon:"/images/icon.png",tabletStartupScreen:"/images/splash-ipad-v.png",phoneStartupScreen:"/images/splash-iphone.png",glossOnIcon:false,launch:function(){setTheme();getOpenhabVersion();setProfile();if(OpenHAB.usePictogramIcons==true){icon_class+=" oph_pictogram";icon_style="-webkit-mask-image:url"}var e=Ext.create("Ext.Panel",{layout:{type:"card"},cls:"oph_background",fullscreen:true,id:"content",autoDestroy:true,items:[]});e.onAfter("activeitemchange",function(e,t,n,r){if(n){n.removeAll(true);n.destroy()}t.on({tap:tapHandler,delegate:"button"})},e);e.onBefore("activeitemchange",function(e,t,n,r){current_widgets=t.getFields();t.on({show:function(){var e=0;var n=0;var r=t.getItems();if(r.length==1){t.addCls("oph_widgets_container_one")}else{t.addCls("oph_widgets_container_many")}for(var i=0;i<r.length;i++){if(e>n){n+=r.items[i].element.dom.clientHeight;r.items[i].addCls(deviceTypeCls+"_fieldset_right")}else{e+=r.items[i].element.dom.clientHeight;r.items[i].addCls(deviceTypeCls+"_fieldset_left")}}}});updateWidgetsAjax(broadCrumb[broadCrumb.length-1][0],"normal")},e);if(deviceType!="Phone"){transition={type:"fade",duration:500};leftNavPanel=e.add(new Ext.NestedList({docked:"left",width:"14em",scrollable:"auto",id:"leftPanel",styleHtmlContent:true,styleHtmlCls:"leftPanelContent",backText:OpenHAB.i18n_strings[ui_language].back,updateTitleText:false,store:leftPanelstore,listeners:{itemtap:NavBarItemTap},getItemTextTpl:function(e){return'<tpl if="icon"><div class="'+icon_class+'" style="'+icon_style+'(/images/{icon}.png);"></div></tpl><div class="oph_label">{text}</div><span class="arrow"></span>'}}));leftNavPanel.doBack=function(e,t,n,r){broadCrumb.pop();if(UIobjects[broadCrumb[broadCrumb.length-1][0]].length>0){if(clickOnLeaf){e.getActiveItem().deselectAll()}else{this.goToNode(t.parentNode)}}else{broadCrumb.pop();this.goToNode(t.parentNode)}clickOnLeaf=false;goToPage(broadCrumb[broadCrumb.length-1][0]);setCurrentLeftNavPage(broadCrumb[broadCrumb.length-1][0]);if(broadCrumb.length<=1){e.getBackButton().hide()}}}e.add({docked:"top",xtype:"toolbar",ui:"light",items:[{id:"back_btn",ui:"back",text:OpenHAB.i18n_strings[ui_language].back,handler:backPage,hidden:true},{xtype:"spacer"},{id:"title",xtype:"label",cls:"oph_title",centered:true,zIndex:0},{xtype:"spacer"},{id:"settings_btn",iconCls:"settings",iconMask:true,handler:showSettingsWindow}]});sitemap=localStorage.getItem("openHAB_sitemap");if(sitemap==""||sitemap==null||sitemap=="null"||sitemap=="choose"){sitemapsPanel=new Ext.Panel(sitemapsWindow);sitemapsPanel.setCls(deviceTypeCls+"_modal");Ext.Viewport.add(sitemapsPanel)}else{loadUIData(sitemap)}}})