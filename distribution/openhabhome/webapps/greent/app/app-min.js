var oph_greenT_version="1.1.0";var oph_greenT_build="1003";var oph_openHAB_version="not known";var oph_update_available=false;var oph_update_version;var oph_update_build;var oph_update_info;var firstload=true;var detectedTransport=null;var socket=$.atmosphere;var fallbackProtocol=null;var current_widgets;function subscribe(_1){var _2={url:_1,maxRequest:256,timeout:59000,attachHeadersAsQueryString:true,executeCallbackBeforeReconnect:false,transport:force_transport,fallbackTransport:fallbackProtocol,headers:{"Accept":"application/json"}};_2.onError=function(_3){};_2.onOpen=function(_4){detectedTransport=_4.transport;};_2.onMessage=function(_5){if(_5.status==200){var _6=_5.responseBody;if(_6.length>0){try{updateWidgets(Ext.JSON.decode(_6));}catch(e){}}}};socket.subscribe(_2);};function unsubscribe(){socket.unsubscribe();};function getOpenhabVersion(){Ext.Ajax.request({url:"/static/version",success:function(_7){oph_openHAB_version=_7.responseText;getUpdateServer();}});};function getUpdateServer(){Ext.Ajax.request({url:"/greent/app/updates_server.cfg",success:function(_8){checkForUpdates(_8.responseText);},failure:function(_9){alert("Error connecting update server!");}});};function checkForUpdates(_a){Ext.data.JsonP.request({url:_a+"/check.php?version="+oph_greenT_build,callbackKey:"callback",success:function(_b,_c){if(_b.status==true){oph_update_available=_b.needsUpdate;oph_update_version=_b.lastBuildName;oph_update_build=_b.lastBuildNumber;oph_update_info=_b.info;if(OpenHAB.enableUpdates=="true"){if(_b.needsUpdate==true){var _d=confirm("GreenT UI version "+_b.lastBuildName+" is available. Do you want to update now?");if(_d){if(!settingsPanel){showSettingsWindow();settingsPanel.setActiveItem(2);}else{settingsPanel.setActiveItem(2);}}}}}else{alert("Error reading update server!");}}});};function updateWidgets(_e){if(Ext.isArray(_e.widget)){for(var i=0 in _e.widget){if(_e.widget[i].type=="Frame"){if(Ext.isArray(_e.widget[i].widget)){for(var k=0 in _e.widget[i].widget){setWidgetData(_e.widget[i].widget[k]);}}else{setWidgetData(_e.widget[i].widget);}}else{setWidgetData(_e.widget[i]);}}}else{setWidgetData(_e.widget);}if(deviceType!="Phone"){if(_e.parent&&_e.parent.id==currentLeftNavPage){setTitle(_e.title);updateLeftNavMenuItem(_e.id,_e.title,_e.icon);}else{if(_e.id==currentLeftNavPage){refreshTitle();}else{refreshTitle();}}}else{setTitle(_e.title);}};var UIobjects={};var UInavPanel={expanded:true,text:"Left nav",children:[]};var ajax_requests=new Array();var broadCrumb=new Array();var broadCrumbText="";var newCard;var settingsPanel=null;var updateModel={};var deviceTypeCls="";var deviceType;var clickOnLeaf=false;var firstTime=true;var sitemap;var currentLeftNavPage;var leftNavPanel;var sitemapUIcontainer;var transition={type:"slide",direction:"left"};var sitemapsPanel;var icon_class="oph_icon";var icon_style="background-image:url";var oph_usepicker;var dirtySettings=false;function getLocalStoreItem(_f,_10){var _11=localStorage.getItem(_f);if(!_11||_11=="null"){return _10;}else{return _11;}};function setTheme(){var _12=getLocalStoreItem("openHAB_theme","GreenT");if(OpenHAB.themes.indexOf(_12)==-1){_12="GreenT";}theme_css_filename="./themes/"+_12+"/css/style.css";var _13=document.createElement("link");_13.setAttribute("rel","stylesheet");_13.setAttribute("type","text/css");_13.setAttribute("href",theme_css_filename);document.getElementsByTagName("head")[0].appendChild(_13);};var ui_language=getLocalStoreItem("openHAB_language","en");var transitions=getLocalStoreItem("openHAB_transitions","1");var force_transport=getLocalStoreItem("openHAB_transport","auto");var chart_servlet=getLocalStoreItem("openHAB_chart_servlet","chart");var sitemapStoreLoadTries=3;var sitemapsStoreSelection=new Ext.data.Store({fields:["name","value"],autoLoad:true});var sitemapsStore=new Ext.data.Store({fields:["name","value"],autoLoad:true,listeners:{exception:function(_14,_15,op,opt){if(sitemapStoreLoadTries>0){sitemapsStore.load();sitemapStoreLoadTries--;}else{sitemapStoreLoadTries=3;alert(OpenHAB.i18n_strings[ui_language].error_server_connection);}},load:function(_16,_17,_18){if(_18){for(record in _17){_17[record].data.value=_17[record].data.name;}sitemapStoreLoadTries=3;sitemapsStoreSelection.insert(0,[{name:"- "+OpenHAB.i18n_strings[ui_language].choose_on_startup,value:"choose"}]);sitemapsStore.each(function(_19){sitemapsStoreSelection.add(_19.copy());});}else{if(sitemapStoreLoadTries>0){sitemapsStore.load();sitemapStoreLoadTries--;}else{sitemapStoreLoadTries=3;alert(OpenHAB.i18n_strings[ui_language].error_server_connection);}}}},proxy:{type:"ajax",url:"/rest/sitemaps",headers:{"Accept":"application/json",},noCache:true,limitParam:undefined,startParam:undefined,pageParam:undefined,reader:{type:"json",rootProperty:"sitemap"}}});var sitemapsWindow={id:"sitemapsWindow",floating:true,centered:true,layout:"fit",scrollable:false,items:[{title:OpenHAB.i18n_strings[ui_language].interfaces,xtype:"toolbar",ui:"light",docked:"top"},{xtype:"list",store:sitemapsStore,singleSelect:true,itemTpl:"{name}",scrollable:false,listeners:{itemtap:function(_1a,_1b,_1c,_1d){sitemap=_1d.data.name;loadUIData(sitemap);sitemapsPanel.destroy();}}}]};function getCurrentPageId(){return broadCrumb[broadCrumb.length-1][0];};var settingsWindow={id:"settingsWindow",floating:true,centered:true,height:500,layout:"card",items:[{scrollable:"vertical",items:[{xtype:"toolbar",ui:"light",docked:"top",items:[{xtype:"spacer"},{xtype:"label",cls:"x-title",centered:true,zIndex:0,html:OpenHAB.i18n_strings[ui_language].settings},{xtype:"spacer"},{iconCls:"delete",iconMask:true,ui:"normal",handler:function(){if(dirtySettings){localStorage.setItem("openHAB_sitemap",settingsPanel.getItems().items[0].getItems().items[1].getValue());localStorage.setItem("openHAB_device_type",settingsPanel.getItems().items[0].getItems().items[2].getValue());localStorage.setItem("openHAB_language",settingsPanel.getItems().items[0].getItems().items[3].getValue());localStorage.setItem("openHAB_theme",settingsPanel.getItems().items[0].getItems().items[4].getValue());localStorage.setItem("openHAB_transport",settingsPanel.getItems().items[0].getItems().items[5].getValue());localStorage.setItem("openHAB_transitions",settingsPanel.getItems().items[0].getItems().items[6].getValue());localStorage.setItem("openHAB_chart_servlet",settingsPanel.getItems().items[0].getItems().items[7].getValue());alert(OpenHAB.i18n_strings[ui_language].need_to_restart_for_changes_to_take_effect);window.location.reload();}settingsPanel.destroy();settingsPanel=null;},}]},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].default_sitemap,labelWidth:"40%",store:sitemapsStoreSelection,displayField:"name",valueField:"value",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true;}}},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].this_device_is,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true;}},options:[{text:OpenHAB.i18n_strings[ui_language].auto_detect,value:"Auto"},{text:OpenHAB.i18n_strings[ui_language].phone,value:"Phone"},{text:OpenHAB.i18n_strings[ui_language].tablet,value:"Tablet"},{text:OpenHAB.i18n_strings[ui_language].pc,value:"Desktop"}],},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].interface_language,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true;}}},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].theme,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true;}}},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].transport_protocol,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true;}}},{xtype:"togglefield",label:OpenHAB.i18n_strings[ui_language].transitions,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true;}}},{xtype:"selectfield",label:OpenHAB.i18n_strings[ui_language].chart_servlet,labelWidth:"40%",style:"border-bottom: 1px solid E6E6E6;",listeners:{change:function(){dirtySettings=true;}}},{xtype:"button",text:"<img style=\"height:100%;\" src=\"./app/logo_tr.png\" border=\"0\" />",style:"clear:both;margin:0.7em 5%;height:3.6em;",scope:this,cls:"oph_about_btn",handler:function(){settingsPanel.setActiveItem(1);}},]},{cls:"oph_about_page",scrollable:"vertical",items:[{xtype:"toolbar",ui:"light",docked:"top",items:[{ui:"back",text:OpenHAB.i18n_strings[ui_language].back,handler:function(){settingsPanel.setActiveItem(0);},},{xtype:"spacer"},{xtype:"label",cls:"x-title",centered:true,zIndex:0,html:"GreenT UI"},{xtype:"spacer"},{iconCls:"delete",iconMask:true,ui:"normal",handler:function(){settingsPanel.destroy();settingsPanel=null;},}]},{xtype:"container",cls:"oph_about_page_content",}]},{cls:"oph_update_page",scrollable:"vertical",items:[{xtype:"toolbar",ui:"light",docked:"top",items:[{ui:"back",text:OpenHAB.i18n_strings[ui_language].back,handler:function(){settingsPanel.setActiveItem(1);},},{xtype:"spacer"},{xtype:"label",cls:"x-title",centered:true,zIndex:0,html:"GreenT UI Update"},{xtype:"spacer"},{iconCls:"delete",iconMask:true,ui:"normal",handler:function(){settingsPanel.destroy();settingsPanel=null;},}]},{xtype:"container",cls:"oph_about_page_content",},{xtype:"button",text:"Update GreenT UI",scope:this,style:"margin:0.8em 5%;height:3em;",ui:"confirm",handler:function(btn){settingsPanel.getItems().items[2].getItems().items[2].destroy();sendCommand("update_greent","ON");settingsPanel.getItems().items[2].getItems().items[1].setHtml("");Ext.defer(readUpdateLog,3000,this);}}]}]};function readUpdateLog(){Ext.Ajax.request({url:"/greent/update.tmp",success:function(_1e){settingsPanel.getItems().items[2].getItems().items[1].setHtml(_1e.responseText);Ext.defer(readUpdateLog,3000,this);},failure:function(_1f){Ext.defer(readUpdateLog,3000,this);}});};function loadUIData(_20){Ext.getCmp("content").setMasked({xtype:"loadmask",message:OpenHAB.i18n_strings[ui_language].loading});Ext.Ajax.request({url:"/rest/sitemaps/"+_20,headers:{"Accept":"application/json",},success:function(_21){try{result=Ext.JSON.decode(_21.responseText);}catch(error){loadUIData(_20);return;}buildUIArray(result.homepage,UInavPanel);clearEmptyFrames();Ext.getCmp("content").unmask();broadCrumb[0]=new Array(result.homepage.id,result.homepage.title);Ext.getCmp("title").setHtml(result.homepage.title);goToPage(result.homepage.id);if(Ext.getCmp("leftPanel")){leftPanelstore.setRoot(UInavPanel);setCurrentLeftNavPage(result.homepage.id);}Ext.getCmp("content").unmask();},failure:function(){alert(OpenHAB.i18n_strings[ui_language].error_server_connection);}});};Ext.define("LeftPanelListItem",{extend:"Ext.data.Model",config:{fields:[{name:"icon",type:"string"},{name:"text",type:"string"},{name:"page_id",type:"string"},{name:"page_label",type:"string"},{name:"name",type:"string"},]}});var leftPanelstore=new Ext.data.TreeStore({model:"LeftPanelListItem",autoLoad:false,proxy:{type:"memory",reader:{type:"json",rootProperty:"children"}}});function pushWidget(_22,_23){if(_22){_23.push(_22);}};function buildUIArray(_24,_25){try{if(_24){var _26;UIobjects[_24.id]=new Array();_26=UIobjects[_24.id];var _27=_24.widget;if(Ext.isArray(_27)){var _28=false;for(var i in _27){if(_27[i].type!="Frame"){if(!_28){_26.push({xtype:"fieldset",title:"",cls:["oph_fieldset",deviceTypeCls+"_fieldset","oph_clearfix"]});_26=_26[_26.length-1]["items"]=new Array();_28=true;}pushWidget(addsWidget(_27[i].widgetId,_27[i],_26,_25),_26);}else{if(_27[i].type=="Frame"){_28=false;_26.push({xtype:"fieldset",title:_27[i].label,cls:["oph_fieldset",deviceTypeCls+"_fieldset","oph_clearfix"]});_26[_26.length-1]["items"]=new Array();if(Ext.isArray(_27[i].widget)){for(var k in _27[i].widget){pushWidget(addsWidget(_27[i].widget[k].widgetId,_27[i].widget[k],_26[_26.length-1]["items"],_25),_26[_26.length-1]["items"]);}}else{pushWidget(addsWidget(_27[i].widget.widgetId,_27[i].widget,_26[_26.length-1]["items"],_25),_26[_26.length-1]["items"]);}}}}}else{if(_27.type!="Frame"){_26.push({xtype:"fieldset",title:"",cls:["oph_fieldset",deviceTypeCls+"_fieldset","oph_clearfix"]});_26=_26[_26.length-1]["items"]=new Array();pushWidget(addsWidget(_27.widgetId,_27,_26,_25),_26);}else{if(_27.type=="Frame"){_26.push({xtype:"fieldset",title:_27.label,cls:["oph_fieldset",deviceTypeCls+"_fieldset","oph_clearfix"]});_26[_26.length-1]["items"]=new Array();if(Ext.isArray(_27.widget)){for(var k in _27.widget){pushWidget(addsWidget(_27.widget[k].widgetId,_27.widget[k],_26[_26.length-1]["items"],_25),_26[_26.length-1]["items"]);}}else{pushWidget(addsWidget(_27.widget.widgetId,_27.widget,_26[_26.length-1]["items"],_25),_26[_26.length-1]["items"]);}}}}}}catch(e){alert(OpenHAB.i18n_strings[ui_language].error_build_interface);}};function clearEmptyFrames(){for(var i in UIobjects){var _29=[];for(var k in UIobjects[i]){if(UIobjects[i][k].items.length>0){_29.push(UIobjects[i][k]);}}UIobjects[i]=_29;}};function addsWidget(id,_2a,_2b,_2c){var _2d;var _2e;if(_2a.type=="Switch"){if(_2a.item&&_2a.item.type=="RollershutterItem"){_2d=createRollershutterWidget(_2a.item?_2a.item.name:"",_2a.label,_2a.icon);}else{if(_2a.item&&_2a.item.type=="NumberItem"){_2d=createButtonsWidget(_2a.item?_2a.item.name:"",_2a.mapping,_2a.label,_2a.icon);}else{if(_2a.item&&_2a.item.type=="SwitchItem"&&_2a.mapping){_2d=createButtonsWidget(_2a.item?_2a.item.name:"",_2a.mapping,_2a.label,_2a.icon);}else{if(_2a.item&&_2a.item.type=="GroupItem"&&_2a.mapping){_2d=createButtonsWidget(_2a.item?_2a.item.name:"",_2a.mapping,_2a.label,_2a.icon);}else{_2d=createToggleWidget(_2a.item?_2a.item.name:"",_2a.label,_2a.icon);}}}}}else{if(_2a.type=="Slider"){_2d=createSliderWidget(_2a.item?_2a.item.name:"",_2a.label,_2a.icon);}else{if(_2a.type=="Setpoint"){_2d=createSetpointWidget(_2a.item?_2a.item.name:"",_2a.minValue,_2a.maxValue,_2a.step,_2a.label,_2a.icon);}else{if(_2a.type=="Video"){_2d=createVideoWidget(_2a.item?_2a.item.name:"",_2a.url,_2a.label,_2a.icon);}else{if(_2a.type=="Webview"){_2d=createWebviewWidget(_2a.item?_2a.item.name:"",_2a.url,_2a.height,_2a.label,_2a.icon);}else{if(_2a.type=="Chart"){_2d=createChartWidget(_2a.item?_2a.item.name:"",id,_2a.w,_2a.h,_2a.period,_2a.refresh,_2a.item?_2a.item.type:"",_2a.label,_2a.icon);}else{if(_2a.type=="Text"){if(_2a.linkedPage){if(deviceType=="Phone"){_2d=createLinkWidget(_2a);}else{_2e=addButtonToLeftNav(id,_2a,_2c);}buildUIArray(_2a.linkedPage,_2e);}else{_2d=createTextWidget(_2a.label,_2a.icon);}}else{if(_2a.type=="Group"){if(deviceType=="Phone"){_2d=createLinkWidget(_2a);}else{_2e=addButtonToLeftNav(id,_2a,_2c);}buildUIArray(_2a.linkedPage,_2e);}else{if(_2a.type=="Selection"){_2d=createSelectionWidget(_2a.item?_2a.item.name:"",_2a.mapping,_2a.label,_2a.icon);}else{if(_2a.type=="Image"){if(_2a.linkedPage){if(deviceType=="Phone"){_2d=createImageLinkWidget(_2a.url,_2a.linkedPage.id,_2a.linkedPage.title);}else{_2e=addButtonToLeftNav(id,_2a,_2c);_2d=createImageLinkWidget(_2a.url,_2a.linkedPage.id,_2a.linkedPage.title);}buildUIArray(_2a.linkedPage,_2e);}else{_2d=createImageWidget(_2a.url);}}else{if(_2a.type=="Frame"){}else{_2d=createUnsupportedWidget();}}}}}}}}}}}if(_2d){_2d.name=id;}return _2d;};function addButtonToLeftNav(id,_2f,_30){if(_2f.linkedPage){page_id=_2f.linkedPage.id;}else{page_id="none";}pushWidget({icon:_2f.icon,text:_2f.label.replace(/[\[\]']+/g,""),page_id:page_id,page_label:_2f.label,leaf:true,name:id,id:id},_30.children);_30.leaf=false;_30.children[_30.children.length-1].children=new Array();return _30.children[_30.children.length-1];};function showSettingsWindow(){if(settingsPanel){settingsPanel.destroy();settingsPanel=null;}else{settingsPanel=new Ext.Panel(settingsWindow);settingsPanel.setCls(deviceTypeCls+"_modal");settingsPanel.getItems().items[0].getItems().items[1].setValue(getLocalStoreItem("openHAB_sitemap","choose"));settingsPanel.getItems().items[0].getItems().items[2].setValue(getLocalStoreItem("openHAB_device_type","auto"));var _31=new Array();for(var i in OpenHAB.i18n_strings){_31.push({text:OpenHAB.i18n_strings[i].language_name,value:i});}settingsPanel.getItems().items[0].getItems().items[3].setOptions(_31);settingsPanel.getItems().items[0].getItems().items[3].setValue(getLocalStoreItem("openHAB_language","en"));_31=[];for(var i in OpenHAB.themes){_31.push({text:OpenHAB.themes[i],value:OpenHAB.themes[i]});}settingsPanel.getItems().items[0].getItems().items[4].setOptions(_31);settingsPanel.getItems().items[0].getItems().items[4].setValue(getLocalStoreItem("openHAB_theme","GreenT"));settingsPanel.getItems().items[0].getItems().items[5].setOptions([{text:OpenHAB.i18n_strings[ui_language].auto_detect,value:"auto"},{text:"Websockets",value:"websocket"},{text:"HTTP Streaming",value:"streaming"},{text:"HTTP Long-polling",value:"long-polling"}]);settingsPanel.getItems().items[0].getItems().items[5].setValue(getLocalStoreItem("openHAB_transport","auto"));settingsPanel.getItems().items[0].getItems().items[6].setValue(transitions);settingsPanel.getItems().items[0].getItems().items[7].setOptions([{text:"Chart engine",value:"chart"},{text:"RRD chart engine",value:"rrdchart.png"}]);settingsPanel.getItems().items[0].getItems().items[7].setValue(getLocalStoreItem("openHAB_chart_servlet","chart"));logo_width=50;if(deviceType=="Phone"){logo_width=85;}update_link="";if(OpenHAB.enableUpdates=="true"||OpenHAB.enableUpdates=="password"){if(oph_update_available){update_link=" <i>(<a href=\"#\" style=\"color:red\" id=\"update_button\">UPDATE</a>)</i>";}else{update_link=" <i>(up to date)</i>";}}settingsPanel.getItems().items[1].getItems().items[1].setHtml("<div style=\"text-align:center;font-size:1em;\"><img style=\"width:"+logo_width+"%;margin:1em;\" src=\"./app/logo.png\" border=\"0\"/><br><b>GreenT UI installed version:</b> "+oph_greenT_version+"<br><b>GreenT UI available version:</b> "+oph_update_version+update_link+"<br><b>openHAB version:</b> "+oph_openHAB_version+"<br><br><b>Transport Protocol:</b> "+detectedTransport+"<br><a style=\"color:#87a600;\" target=\"_blank\" href=\"http://m-design.bg/greent/\">GreenT UI Website</a></div>");settingsPanel.getItems().items[2].getItems().items[1].setHtml("<div style=\"padding-top:0.5em;text-align:center;font-size:1em;\"><b>Installed version:</b> "+oph_greenT_version+" <i>(build "+oph_greenT_build+")</i><br><b>Version to update: </b>"+oph_update_version+" <i>(build "+oph_update_build+")</i><br><br><b>Update info:</b><br>"+oph_update_info+"</div><br><br>");Ext.Viewport.add(settingsPanel);try{Ext.get("update_button").clearListeners();Ext.get("update_button").on("tap",function(){if(OpenHAB.enableUpdates=="password"){var _32=prompt("Enter a password:","");if(_32==OpenHAB.updatesPassword){settingsPanel.setActiveItem(2);}else{alert("Wrong password!");}}else{if(OpenHAB.enableUpdates=="true"){settingsPanel.setActiveItem(2);}}});}catch(e){}dirtySettings=false;}};function NavBarItemTap(_33,_34,_35,e,_36){if(_36.raw.page_id=="none"){return;}leftNavPanel.getBackButton().show();if(_36.raw.leaf){if(clickOnLeaf){broadCrumb.pop();}clickOnLeaf=true;}else{if(clickOnLeaf){broadCrumb.pop();}clickOnLeaf=false;setCurrentLeftNavPage(_36.raw.page_id);}broadCrumb.push([_36.raw.page_id,_36.raw.page_label]);if(UIobjects[_36.raw.page_id].length>0){goToPage(_36.raw.page_id);}};function tapHandler(btn,evt){if(btn.config.page_id=="none"){return;}btn.addCls("selected");if(deviceType=="Phone"){broadCrumb.push([btn.config.page_id,btn.config.page_label]);transition={type:"slide",direction:"left"};goToPage(btn.config.page_id);}else{leftNav=Ext.getCmp("leftPanel").getActiveItem();index=leftNav.getStore().getAt(leftNav.getStore().find("page_id",btn.config.page_id)).data.index;leftNav.select(index,false,false);NavBarItemTap(leftNav,"",index,"",leftNav.getStore().getAt(leftNav.getStore().find("page_id",btn.config.page_id)));}};function backPage(){if(broadCrumb.length>1){broadCrumb.pop();transition={type:"slide",direction:"right"};goToPage(broadCrumb[broadCrumb.length-1][0]);}};function goToPage(_37){newCard=new Oph.form.Panel({scrollable:"vertical",autoDestroy:true,cls:["oph_widgets_container",deviceTypeCls+"_widgets_container"]});newCard.add(UIobjects[_37]);if(transitions=="0"){Ext.getCmp("content").setActiveItem(newCard);}else{if(transitions=="1"){Ext.getCmp("content").animateActiveItem(newCard,transition);}}};function updateWidgetsAjax(_38,_39){if(_38==getCurrentPageId()){var _3a="";var _3b=5000;if(!_39||_39=="normal"){_3a={"Accept":"application/json"};}else{if(_39=="long-poll"){unsubscribe();subscribe("/rest/sitemaps/"+sitemap+"/"+_38);return;}}for(var i=ajax_requests.length-1;i>=0;i--){if(ajax_requests.hasOwnProperty(i)){Ext.Ajax.abort(ajax_requests[i]);ajax_requests.pop();}}req=Ext.Ajax.request({url:"/rest/sitemaps/"+sitemap+"/"+_38,headers:_3a,disableCaching:true,timeout:_3b,failure:function(_3c){if(_39=="long-poll"){updateWidgetsAjax(_38,"long-poll");}else{updateWidgetsAjax(_38,"normal");}},success:function(_3d){if(_3d.statusText=="OK"&&_3d.responseText!=""){try{var _3e=Ext.JSON.decode(_3d.responseText);}catch(exception){updateWidgetsAjax(_38,"normal");return;}updateWidgets(_3e);updateWidgetsAjax(_38,"long-poll");}else{}}});ajax_requests.push(req);}};function setWidgetData(_3f){if(current_widgets[_3f.widgetId]){current_widgets[_3f.widgetId].setValueData(_3f);}else{if(deviceType!="Phone"){updateLeftNavMenu(_3f);}}};function updateLeftNavMenuItem(_40,_41,_42){nav_store=Ext.getCmp("leftPanel").getActiveItem().getStore();index=nav_store.find("page_id",_40);if(index!=-1){nav_store.getAt(index).set("text",_41.replace(/[\[\]']+/g,""));nav_store.getAt(index).set("icon",_42);}};function updateLeftNavMenu(_43){nav_store=Ext.getCmp("leftPanel").getActiveItem().getStore();index=nav_store.find("name",_43.widgetId);if(index!=-1){nav_store.getAt(index).set("text",_43.label.replace(/[\[\]']+/g,""));nav_store.getAt(index).set("icon",_43.icon);}};function setProfile(){if(force_transport=="auto"){force_transport="websocket";fallbackProtocol="streaming";if(Ext.os.is.Android2){fallbackProtocol="long-polling";}}else{fallbackProtocol=force_transport;}oph_usepicker="auto";deviceType=localStorage.getItem("openHAB_device_type");if(deviceType&&deviceType!="Auto"){}else{deviceType=Ext.os.deviceType;}if(deviceType=="Phone"){deviceTypeCls="oph_phone";oph_usepicker=true;}else{if(deviceType=="Tablet"){deviceTypeCls="oph_tablet";oph_usepicker=false;}else{deviceTypeCls="oph_desktop";oph_usepicker=false;}}};Ext.define("Oph.field.ButtonsSelect",{extend:"Ext.field.Field",xtype:"oph_buttons_selectfield",config:{cls:"x-buttons-field",styleHtmlContent:true,styleHtmlCls:"oph_none",labelWidth:"50%"},constructor:function(_44){_44=_44||{};this.callParent([_44]);},applyComponent:function(_45){component=this;container=Ext.factory({styleHtmlContent:true,styleHtmlCls:"oph_right"},Ext.Container);if(Ext.isArray(this.config.options)){for(var i in this.config.options){item=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_selection_btn",item:component.config.oph_item,command:component.config.options[i].command,text:this.config.options[i].label}));item.on({tap:function(){sendCommand(this.config.item,this.config.command);}});}}else{item=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_selection_btn",item:component.config.oph_item,command:component.config.options.command,text:this.config.options.label}));item.on({tap:function(){sendCommand(this.config.item,this.config.command);}});}return container;},initialize:function(){this.callParent();},setValueData:function(_46){this.setLabel("<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_46.icon+".png);\"></div><div class=\"oph_label\">"+_46.label.replace(/[\[\]']+/g,"")+"</div>");if(Ext.isArray(_46.mapping)){for(var i in _46.mapping){this._component._items.items[i].removeCls("x-button-action");if(_46.item.state==_46.mapping[i].command){this._component._items.items[i].addCls("x-button-action");}}}else{this._component._items.items[0].addCls("x-button-action");}}});Ext.define("Oph.field.Slider",{extend:"Ext.field.Slider",xtype:"oph_sliderfield",config:{labelWidth:"50%"},constructor:function(_47){_47=_47||{};this.callParent([_47]);},initialize:function(){this.callParent();this.on({painted:function(_48){_48._component.element.on({tap:function(){sendCommand(_48.config.oph_item,_48.getValue());}});_48._component.getThumb(0).element.on({dragend:function(){sendCommand(_48.config.oph_item,_48.getValue());}});}});},setValueData:function(_49){if(_49.item){this.setValue(_49.item.state);}this.setLabel("<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_49.icon+".png);\"></div><div class=\"oph_label\">"+_49.label.replace(/[\[\]']+/g,"")+"</div>");return this;}});Ext.define("Oph.field.Setpoint",{extend:"Ext.field.Spinner",xtype:"oph_setpointfield",config:{labelWidth:"50%"},constructor:function(_4a){_4a=_4a||{};this.callParent([_4a]);},initialize:function(){this.callParent();this.on({spindown:function(_4b,_4c){sendCommand(_4b.config.oph_item,_4c);},spinup:function(_4d,_4e){sendCommand(_4d.config.oph_item,_4e);},});},setValueData:function(_4f){if(_4f.item){if(_4f.item.state=="Uninitialized"){this.setValue(Number(this.config.minValue));}else{this.setValue(Number(_4f.item.state));}}this.setLabel("<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_4f.icon+".png);\"></div><div class=\"oph_label\">"+_4f.label.replace(/[\[\]']+/g,"")+"</div>");return this;}});Ext.define("Oph.field.Select",{extend:"Ext.field.Select",xtype:"oph_selectfield",config:{displayField:"label",valueField:"command",labelWidth:"50%"},constructor:function(_50){_50=_50||{};this.callParent([_50]);},initialize:function(){this.callParent();this.on({painted:function(_51){_51.on({selected:function(){sendCommand(_51.config.oph_item,_51.getValue());}});}});},setValueData:function(_52){if(_52.item){this.setValue(_52.item.state);}this.setLabel("<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_52.icon+".png);\"></div><div class=\"oph_label\">"+_52.label.replace(/[\[\]']+/g,"")+"</div>");return this;},onListSelect:function(_53,_54){var me=this;if(_54){me.setValue(_54);this.fireEvent("selected",this);}},onPickerChange:function(_55,_56){var me=this,_57=me.getValue(),_58=_56[me.getName()],_59=me.getStore(),_5a=_59.find(me.getValueField(),_58);record=_59.getAt(_5a);me.setValue(record);this.fireEvent("selected",this);},});Ext.define("Oph.field.Text",{extend:"Ext.field.Field",xtype:"oph_textfield",config:{cls:"x-textfield",styleHtmlContent:true,styleHtmlCls:"oph_none",labelWidth:"50%"},constructor:function(_5b){_5b=_5b||{};this.callParent([_5b]);},initialize:function(){this.callParent();},setValueData:function(_5c){this.setHtml(_5c.label.match(/\[(.*?)\]/)?_5c.label.match(/\[(.*?)\]/)[1]:_5c.label);this.setLabel("<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_5c.icon+".png);\"></div><div class=\"oph_label\">"+_5c.label.replace(/\[(.*?)\]/,"")+"</div>");return this;}});Ext.define("Oph.field.Toggle",{extend:"Ext.field.Toggle",xtype:"oph_togglefield",config:{labelWidth:"50%"},constructor:function(_5d){_5d=_5d||{};this.callParent([_5d]);},initialize:function(){this.callParent();this.on({painted:function(_5e){_5e._component.element.on({singletap:function(){sendCommand(_5e.config.oph_item,_5e.formatOutputValue(_5e.getValue()));}});_5e._component.getThumb(0).element.on({dragend:function(){sendCommand(_5e.config.oph_item,_5e.formatOutputValue(_5e.getValue()));}});}});},setValueData:function(_5f){if(_5f.item){this.setValue(this.formatInputValue(_5f.item.state));}this.setLabel("<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_5f.icon+".png);\"></div><div class=\"oph_label\">"+_5f.label.replace(/[\[\]']+/g,"")+"</div>");return this;},formatInputValue:function(_60){if(_60=="ON"){return 1;}else{return 0;}},formatOutputValue:function(_61){if(_61==1){return "ON";}else{if(_61==0){return "OFF";}}}});function sendCommand(_62,_63){if(_62){Ext.Ajax.request({comm_method:"ajax",url:"/rest/items/"+_62+"/",method:"POST",params:_63,headers:{"Content-Type":"text/plain"},failure:function(){}});}};Ext.define("Oph.field.Rollershutter",{extend:"Ext.field.Field",xtype:"oph_rollershutterfield",config:{cls:"x-rollershutter-field",styleHtmlContent:true,styleHtmlCls:"oph_none",labelWidth:"50%"},constructor:function(_64){_64=_64||{};this.callParent([_64]);},applyComponent:function(_65){component=this;container=Ext.factory({styleHtmlContent:true,styleHtmlCls:"oph_right"},Ext.Container);but1=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_rollershutter_btn",longPress:false,iconCls:"arrow_up",iconMask:true}));but1.element.item=component.config.oph_item;but1.element.on({touchstart:function(){sendCommand(this.item,"UP");},longpress:function(){but1.longPress=true;},tap:function(){if(but1.longPress){but1.longPress=false;sendCommand(this.item,"STOP");}}});but2=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_rollershutter_btn",iconCls:"delete",iconMask:true}));but2.element.item=component.config.oph_item;but2.element.on({tap:function(){sendCommand(this.item,"STOP");}});but3=container.add(Ext.create("Ext.Button",{cls:"x-button-normal oph_rollershutter_btn",longPress:false,iconCls:"arrow_down",iconMask:true}));but3.element.item=component.config.oph_item;but3.element.on({touchstart:function(){sendCommand(this.item,"DOWN");},longpress:function(){but3.longPress=true;},tap:function(){if(but3.longPress){but3.longPress=false;sendCommand(this.item,"STOP");}}});return container;},initialize:function(){this.callParent();},initialize:function(){this.callParent();},setValueData:function(_66){this.setLabel("<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_66.icon+".png);\"></div><div class=\"oph_label\">"+_66.label.replace(/[\[\]']+/g,"")+"</div>");return this;}});Ext.define("Oph.field.Button",{extend:"Ext.Button",xtype:"oph_buttonfield",isField:true,config:{style:"display:block",baseCls:"x-field oph_group_btn oph_button",labelCls:"",isField:true,cls:"oph_link"},constructor:function(_67){_67=_67||{};this.callParent([_67]);},initialize:function(){this.callParent();},setValueData:function(_68){this.setHtml("<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_68.icon+".png);\"></div><div class=\"oph_label\">"+_68.label.replace(/[\[\]']+/g,"")+"</div><span class=\"arrow\"></span>");return this;},getName:function(){return this.config.name;}});Ext.define("Oph.field.Webview",{extend:"Ext.Container",xtype:"oph_webviewfield",constructor:function(_69){_69=_69||{};this.callParent([_69]);var _6a=58*Number(_69.oph_height);if(deviceType=="Phone"){_6a=52*Number(_69.oph_height);}this.setHeight(_6a+18);this.setStyle("position:relative;padding:0.4em;");this.setHtml("<div class=\"oph_webview_mask\" style=\"z-index:999;position:absolute;top:0;left:0;width:100%;height:"+_6a+"px;\"></div>\t\t<div style=\"position:absolute;top:0;left:0;overflow:hidden;height:"+Number(_6a+20)+"px;width:100%;\"><iframe scrolling=\"no\" src=\""+_69.url+"\" width=\"100%\" height="+_6a+" style=\"border:1px solid gray;\"></iframe></div>");},initialize:function(){this.callParent();},setValueData:function(_6b){}});Ext.define("Oph.field.Video",{extend:"Ext.Video",xtype:"oph_videofield",constructor:function(_6c){_6c=_6c||{};this.callParent([_6c]);if(_6c.url.substr(0,4)!="http"&&_6c.url.substr(0,1)!="/"){_6c.url="/"+_6c.url;}},initialize:function(){this.callParent();this.ghost.setHtml("<div style=\"text-align:center;padding-top:1em;\">"+this.config.oph_label+"</div>");},setValueData:function(_6d){}});Ext.define("Oph.field.Chart",{extend:"Ext.Container",xtype:"oph_chartfield",refreshInterval:null,constructor:function(_6e){_6e=_6e||{};var _6f="items";if(_6e.oph_type=="GroupItem"){_6f="groups";}_6e.img_src="/"+chart_servlet+"?"+_6f+"="+_6e.oph_item+"&period="+_6e.oph_period;this.callParent([_6e]);this.setHtml("<div style=\"width:100%;padding:0.4em;\"><img id=\"img"+_6e.oph_id+"\" src=\""+_6e.img_src+"&random="+new Date().getTime()+"\" style=\"width:100%;\"></div>");},initialize:function(){this.callParent();this.on({painted:function(_70){if(_70.config.oph_refresh>0){_70.config.refreshInterval=window.setInterval(function(){_70.updateImage(_70);},_70.config.oph_refresh);}},erased:function(_71){if(_71.config.oph_refresh>0){window.clearInterval(_71.config.refreshInterval);}}});},setValueData:function(_72){},updateImage:function(_73){Ext.fly("img"+_73.config.oph_id).dom.src=_73.config.img_src+"&random="+new Date().getTime();}});Ext.define("Oph.field.Image",{extend:"Ext.Container",xtype:"oph_imagefield",constructor:function(_74){_74=_74||{};this.callParent([_74]);if(_74.url.substr(0,4)!="http"&&_74.url.substr(0,1)!="/"){_74.url="/"+_74.url;}this.setHtml("<div style=\"width:100%;padding:0.4em;\"><img src=\""+_74.url+"\" style=\"width:100%;\"></div>");},initialize:function(){this.callParent();},setValueData:function(_75){}});Ext.define("Oph.field.ImageLink",{extend:"Ext.Button",xtype:"oph_imagelink",config:{style:"display:block",baseCls:"none",labelCls:"",cls:"oph_link"},constructor:function(_76){_76=_76||{};this.callParent([_76]);if(_76.url.substr(0,4)!="http"&&_76.url.substr(0,1)!="/"){_76.url="/"+_76.url;}this.setHtml("<div style=\"width:100%;padding:0.4em;\"><img src=\""+_76.url+"\" style=\"width:100%;\"></div>");},initialize:function(){this.callParent();},setValueData:function(_77){}});Ext.define("Oph.form.Panel",{extend:"Ext.Panel",xtype:"oph_formpanel",constructor:function(_78){_78=_78||{};this.callParent([_78]);},initialize:function(){this.callParent();},setValuesData:function(_79){var _7a=this.getFields(),_7b,_7c,_7d;_79=_79||{};for(_7b in _79){if(_79.hasOwnProperty(_7b)){_7c=_7a[_7b];_7d=_79[_7b];if(_7c){_7c.setValueData(_7d);}}}return this;},getFields:function(_7e){var _7f={},_80;var _81=function(_82){if(_82.isField){_80=_82.getName();if((_7e&&_80==_7e)||typeof _7e=="undefined"){if(_7f.hasOwnProperty(_80)){if(!Ext.isArray(_7f[_80])){_7f[_80]=[_7f[_80]];}_7f[_80].push(_82);}else{_7f[_80]=_82;}}}if(_82.isContainer){_82.items.each(_81);}};this.items.each(_81);return (_7e)?(_7f[_7e]||[]):_7f;},});function createSliderWidget(_83,_84,_85){return {xtype:"oph_sliderfield",minValue:0,maxValue:100,oph_item:_83,label:"<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_85+".png);\"></div><div class=\"oph_label\">"+_84.replace(/[\[\]']+/g,"")+"</div>"};};function createTextWidget(_86,_87){return {xtype:"oph_textfield",html:_86.match(/\[(.*?)\]/)?_86.match(/\[(.*?)\]/)[1]:_86,label:"<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_87+".png);\"></div><div class=\"oph_label\">"+_86.replace(/\[(.*?)\]/,"")+"</div>"};};function createToggleWidget(_88,_89,_8a){return {xtype:"oph_togglefield",oph_item:_88,label:"<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_8a+".png);\"></div><div class=\"oph_label\">"+_89.replace(/[\[\]']+/g,"")+"</div>"};};function createRollershutterWidget(_8b,_8c,_8d){return {xtype:"oph_rollershutterfield",oph_item:_8b,label:"<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_8d+".png);\"></div><div class=\"oph_label\">"+_8c.replace(/[\[\]']+/g,"")+"</div>"};};function createLinkWidget(_8e){page_label=_8e.label;if(_8e.linkedPage){page_id=_8e.linkedPage.id;}else{page_id="none";}return {xtype:"oph_buttonfield",page_id:page_id,page_label:page_label};};function createImageLinkWidget(url,_8f,_90){return {xtype:"oph_imagelink",url:url,page_id:_8f,page_label:_90,};};function createSelectionWidget(_91,_92,_93,_94){return {xtype:"oph_selectfield",options:_92,oph_item:_91,usePicker:oph_usepicker,label:"<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_94+".png);\"></div><div class=\"oph_label\">"+_93.replace(/[\[\]']+/g,"")+"</div>"};};function createSetpointWidget(_95,_96,_97,_98,_99,_9a){return {xtype:"oph_setpointfield",oph_item:_95,minValue:Number(_96),maxValue:Number(_97),increment:Number(_98),defaultValue:_96,cycle:false,label:"<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_9a+".png);\"></div><div class=\"oph_label\">"+_99.replace(/[\[\]']+/g,"")+"</div>"};};function createVideoWidget(_9b,url,_9c,_9d){return {xtype:"oph_videofield",oph_item:_9b,url:url,width:"100%",height:"16em",style:"background-color:white;",posterUrl:"./app/video.png",oph_label:_9c};};function createWebviewWidget(_9e,url,_9f,_a0,_a1){return {xtype:"oph_webviewfield",oph_item:_9e,url:url,width:"100%",height:"16em",oph_label:_a0,oph_height:_9f,};};function createButtonsWidget(_a2,_a3,_a4,_a5){return {xtype:"oph_buttons_selectfield",options:_a3,oph_item:_a2,label:"<div class=\""+icon_class+"\" style=\""+icon_style+"(/images/"+_a5+".png);\"></div><div class=\"oph_label\">"+_a4.replace(/[\[\]']+/g,"")+"</div>"};};function createUnsupportedWidget(){return {xtype:"field",label:"[UNSUPPORTED WIDGET]",};};function createImageWidget(url){return {xtype:"oph_imagefield",url:url,cls:"x-image-field",};};function createChartWidget(_a6,_a7,_a8,_a9,_aa,_ab,_ac,_ad,_ae){return {xtype:"oph_chartfield",oph_item:_a6,oph_w:_a8,oph_h:_a9,oph_period:_aa,oph_refresh:_ab,oph_id:_a7,oph_type:_ac,img_src:""};};var oph_app=Ext.application({name:"OpenHAB",icon:"/images/icon.png",tabletStartupScreen:"/images/splash-ipad-v.png",phoneStartupScreen:"/images/splash-iphone.png",glossOnIcon:false,launch:function(){setTheme();getOpenhabVersion();setProfile();if(OpenHAB.usePictogramIcons==true){icon_class+=" oph_pictogram";icon_style="-webkit-mask-image:url";}var _af=Ext.create("Ext.Panel",{layout:{type:"card",},cls:"oph_background",fullscreen:true,id:"content",autoDestroy:true,items:[]});_af.onAfter("activeitemchange",function(_b0,_b1,_b2,_b3){if(_b2){_b2.removeAll(true);_b2.destroy();}_b1.on({tap:tapHandler,delegate:"button"});},_af);_af.onBefore("activeitemchange",function(_b4,_b5,_b6,_b7){current_widgets=_b5.getFields();_b5.on({show:function(){var _b8=0;var _b9=0;var _ba=_b5.getItems();if(_ba.length==1){_b5.addCls("oph_widgets_container_one");}else{_b5.addCls("oph_widgets_container_many");}for(var i=0;i<_ba.length;i++){if(_b8>_b9){_b9+=_ba.items[i].element.dom.clientHeight;_ba.items[i].addCls(deviceTypeCls+"_fieldset_right");}else{_b8+=_ba.items[i].element.dom.clientHeight;_ba.items[i].addCls(deviceTypeCls+"_fieldset_left");}}}});updateWidgetsAjax(broadCrumb[broadCrumb.length-1][0],"normal");},_af);if(deviceType!="Phone"){transition={type:"fade",duration:500};leftNavPanel=_af.add(new Ext.NestedList({docked:"left",width:"14em",scrollable:"auto",id:"leftPanel",styleHtmlContent:true,styleHtmlCls:"leftPanelContent",backText:OpenHAB.i18n_strings[ui_language].back,updateTitleText:false,store:leftPanelstore,listeners:{itemtap:NavBarItemTap,},getItemTextTpl:function(_bb){return "<tpl if=\"icon\"><div class=\""+icon_class+"\" style=\""+icon_style+"(/images/{icon}.png);\"></div></tpl><div class=\"oph_label\">{text}</div><span class=\"arrow\"></span>";}}));leftNavPanel.doBack=function(me,_bc,_bd,_be){broadCrumb.pop();if(UIobjects[broadCrumb[broadCrumb.length-1][0]].length>0){if(clickOnLeaf){me.getActiveItem().deselectAll();}else{this.goToNode(_bc.parentNode);}}else{broadCrumb.pop();this.goToNode(_bc.parentNode);}clickOnLeaf=false;goToPage(broadCrumb[broadCrumb.length-1][0]);setCurrentLeftNavPage(broadCrumb[broadCrumb.length-1][0]);if(broadCrumb.length<=1){me.getBackButton().hide();}};}_af.add({docked:"top",xtype:"toolbar",ui:"light",items:[{id:"back_btn",ui:"back",text:OpenHAB.i18n_strings[ui_language].back,handler:backPage,hidden:true,},{xtype:"spacer"},{id:"title",xtype:"label",cls:"oph_title",centered:true,zIndex:0},{xtype:"spacer"},{id:"settings_btn",iconCls:"settings",iconMask:true,handler:showSettingsWindow}]});sitemap=localStorage.getItem("openHAB_sitemap");if(sitemap==""||sitemap==null||sitemap=="null"||sitemap=="choose"){sitemapsPanel=new Ext.Panel(sitemapsWindow);sitemapsPanel.setCls(deviceTypeCls+"_modal");Ext.Viewport.add(sitemapsPanel);}else{loadUIData(sitemap);}}});function setTitle(_bf){broadCrumb[broadCrumb.length-1][1]=_bf;refreshTitle();};function refreshTitle(){if(deviceType=="Phone"){if(broadCrumb.length==1){Ext.getCmp("back_btn").hide();}else{Ext.getCmp("back_btn").show();}broadCrumbText=broadCrumb[broadCrumb.length-1][1].replace(/[\[\]']+/g,"");}else{broadCrumbText="";for(var k in broadCrumb){broadCrumbText+=broadCrumb[k][1].replace(/[\[\]']+/g,"");if(k!=broadCrumb.length-1){broadCrumbText+=" > ";}}}Ext.getCmp("title").setHtml(broadCrumbText);};function setCurrentLeftNavPage(_c0){currentLeftNavPage=_c0;};